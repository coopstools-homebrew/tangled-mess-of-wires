# Tangled-mess-of-wires Controller Node Setup
This folder covers setting up the main node.

For clarification, and I apologize for this, I use multiple words/phrases interchangeably: Controller (ctrl) <-> Main, and Node <-> Box <-> Machine. So, the Ctrl Node is the same as the Main Box.

## New Machine initial setup

Load ubuntu 20. Easiest through a thumb drive.

`sudo apt update`

`sudo apt install net-tools vi openssh-server curl`

Verify with `sudo systemctl status ssh`

Open up the firewall with `sudo ufw allow ssh`

`mkdir ~/.ssh`

At this point, you will want to add your public key to the ~/.ssh/authorized_keys at this point. It's your choice of how to copy it over. I use scp with `scp ~/.ssh/coopstools.pub coopstools@coopstools-sf-core-box:~/.ssh/authorized_keys`

Verify the hostname, at `/etc/hostname` is set to a value you want to use.

Then finally, we are going to disable password login with the following command
`sed -i "s/#PasswordAuthentication yes/PasswordAuthentication no/g" /etc/ssh/sshd_config`

We are now done with working on the k8s controller machine. From here on, we can work through ssh (or better yet, ansible).

## Enabling connections
From here we can unplug the keyboard, mouse, and monitor(s) from the k8s controller machine. We can do the rest of our work through ansible and ssh.

I recommend updating your ssh config with the hostname of the controller machine. I'm adding an entry like this:
```
HOST k8sctrl
  HostName coopstools-sf-core-box
  User coopstools
  IdentityFile ~/.ssh/coopstools
```
Now, we should be able to ssh into our machine.

Now that password login has been disabled, we can open the ssh port to the public. I only use this step because I am often on a vpn that does not allow direct LAN connections. As this step is unique for every router, I won't list the steps here. Just look up port forwarding with the name of your home router. On your router, you should open ports 22 (ssh), 6443 (kubectl), and port 80 (you eventual website).

Next we want to enable DynDNS through your domain provider.

`sudo apt-get install ddclient`

It will ask for a bunch of info, such as protocol (googledomains) and DynDNS interface (web). The username and password are generated by google domains after you create the DynDNS entry. Of course, this all assumes you use google domains. You'll have to lookup how to setup a DynDNS entry with whichever provider you use. But for google, here's link to the (outdated) guide https://support.google.com/domains/answer/6147083?hl=en#zippy=%2Cset-up-a-client-program-on-your-gateway-host-or-server

At this point, update your ssh config again and add a new entry under the first:
```
HOST k8sremote
  HostName home.coopstools.com <- The domain you've given to this setup
  User coopstools
  IdentityFile ~/.ssh/coopstool
```

Then test by running `ssh k8sremote`

## Installing k3s

For this approach, I've written out the ansible and ssh approaches. Your first time through, I recommend the manual. The automated ansible is just nice when you've done this a few times and want to speed things up.

### (Option A) Installing k3s, ansible approach

The hosts have been saved in the etc_ansible folder.

You can build the ansible docker iage instead of installing ansible locally:
`docker build -t my/ansible -f AnsibleDockerfile .` <- assumes you are in the controller folder

`docker run -it --rm -v $(pwd)/etc_ansible:/etc/ansible -v $(echo ~)/.ssh:/root/.ssh -v $(pwd)/playbooks:/root/playbooks my/ansible /bin/bash`

Inside the container run `eval 'ssh-agent -s'` and `ssh-add .ssh/coopstools`

The k3s_install playbook installs a very lightweight k3s instance. For installing HA k3s (or for uninstalling) see here: https://rancher.com/docs/k3s/latest/en/installation/

`ansible-playbook playbooks/k3s_install.yaml --ask-become-pass`

### (Option B) Installing k3s, manual approach

SSH into control machine and run:
`curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=latest sh - --disable=traefik`

This will install k3s without Traefik, their version of ingress. Instead we will install nginx ingress.

Then pull out the file `/etc/rancher/k3s/k3s.yaml` from the server. Keep in mind, this file assumes access from inside the box. You will need to update the k3s.yaml to allow access from other hosts.

Finally, we need to install nginx-ingress into the cluster.
```
cat >/var/lib/rancher/k3s/server/manifests/ingress-nginx.yaml <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: ingress-nginx
  namespace: kube-system
spec:
  chart: nginx-ingress
  repo: https://kubernetes.github.io/ingress-nginx
  targetNamespace: ingress-nginx
  version: v2.10.0
  set:
  valuesContent: |-
    fullnameOverride: ingress-nginx
    controller:
      kind: DaemonSet
      hostNetwork: true
      service:
        enabled: false
      publishService:
        enabled: false
      metrics:
        enabled: true
      config:
        use-forwarded-headers: "true"
EOF
```
